╔══════════════════════════════════════════════════════════════════════════╗
║         АЛГОРИТМ РАСЧЁТА ПРОИЗВОДИТЕЛЬНОСТИ ОПЕРАЦИИ                     ║
╚══════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────┐
│  ШАГ 1: Определение типа операции                                       │
└─────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────┴───────────────┐
              │                               │
         ONE_TIME                        PER_UNIT
      (разовая операция)            (поточная операция)
              │                               │
              ▼                               ▼
    Производится весь            Производится с определённой
    тираж за один раз              скоростью (шт/час)
              │                               │
              │                               │
              └───────────────┬───────────────┘
                              │
                              ▼

┌─────────────────────────────────────────────────────────────────────────┐
│  ШАГ 2: Расчёт производительности (только для PER_UNIT)                 │
└─────────────────────────────────────────────────────────────────────────┘

    ┌────────────────────────────────────────────────────────────────┐
    │  A. Номинальная производительность операции                    │
    │  baseProductivity = estimatedProductivityPerHour ± variance    │
    │  Если не указана → Infinity (не лимитирует)                    │
    └────────────────────────────────────────────────────────────────┘
                              │
                              ▼
    ┌────────────────────────────────────────────────────────────────┐
    │  B. Производительность оборудования                            │
    │  equipmentProductivity = MIN(все piecesPerHour ± variance)     │
    │  ⚠️ Учитывается только оборудование с piecesPerHour > 0       │
    │  ⚠️ Если ни у одного не указано → Infinity                     │
    └────────────────────────────────────────────────────────────────┘
                              │
                              ▼
    ┌────────────────────────────────────────────────────────────────┐
    │  C. Производительность работников                              │
    │  roleProductivity = MIN(все piecesPerHour ± variance)          │
    │  ⚠️ Учитываются только роли с piecesPerHour > 0               │
    │  ⚠️ Если ни у одной не указано → Infinity                      │
    └────────────────────────────────────────────────────────────────┘
                              │
                              ▼
    ┌────────────────────────────────────────────────────────────────┐
    │  D. Итоговая производительность ("узкое горлышко")             │
    │                                                                │
    │  realProductivity = MIN(                                       │
    │      baseProductivity,                                         │
    │      equipmentProductivity,                                    │
    │      roleProductivity                                          │
    │  )                                                             │
    │                                                                │
    │  ⚠️ Если все = Infinity → используется 1 шт/час               │
    └────────────────────────────────────────────────────────────────┘
                              │
                              ▼
    ┌────────────────────────────────────────────────────────────────┐
    │  E. Применение коэффициента отдыха                             │
    │  realProductivity = realProductivity × breakCoefficient        │
    │  где breakCoefficient = 1 - (breakMinutes / 60)                │
    └────────────────────────────────────────────────────────────────┘
                              │
                              ▼
    ┌────────────────────────────────────────────────────────────────┐
    │  F. Производство за цикл                                       │
    │  producedThisCycle = floor(realProductivity × cycleHours)      │
    │  ⚠️ Если result >= 0.5 → минимум 1 деталь                     │
    │  ⚠️ Ограничивается остатком тиража                            │
    └────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════╗
║                     ПРИМЕР: Операция "Галтовка"                          ║
╚══════════════════════════════════════════════════════════════════════════╝

Входные данные:
┌──────────────────────────────────────────────────────────────────────┐
│ Номинальная: 1600 шт/час ± 20%                                       │
│ Оборудование:                                                        │
│   • Галтовка ТурбоШлиф: 1200 шт/час                                  │
│   • Печь для галтовки: 1600 шт/час (requiresContinuousOperation)     │
│   • Галтовочные камни: 1200 шт/час                                   │
│ Работники:                                                           │
│   • Галтовщик: 1600 шт/час ± 20%                                     │
│ Цикл: 1 час, Перерывы: 10 мин/час                                    │
└──────────────────────────────────────────────────────────────────────┘

Расчёт (variance = MIN):
    baseProductivity     = 1600 × 0.8   = 1280 шт/час
    equipmentProductivity = MIN(1200, 1600, 1200) = 1200 шт/час  ← ЛИМИТИРУЕТ!
    roleProductivity     = 1600 × 0.8   = 1280 шт/час
                                    │
                                    ▼
    realProductivity     = MIN(1280, 1200, 1280) = 1200 шт/час
    с учётом отдыха      = 1200 × 0.833 = 1000 шт/час
    за 1 час             = floor(1000 × 1) = 1000 шт

Раньше (с ошибкой):
    Печь = 600 шт/час → equipmentProductivity = MIN(1200, 600, 1200) = 600
    → realProductivity = MIN(1280, 600, 1280) = 600 × 0.833 = 500 шт/час ❌

Теперь (исправлено):
    Печь = 1600 шт/час → equipmentProductivity = MIN(1200, 1600, 1200) = 1200
    → realProductivity = MIN(1280, 1200, 1280) = 1200 × 0.833 = 1000 шт/час ✅

╔══════════════════════════════════════════════════════════════════════════╗
║                     КЛЮЧЕВЫЕ ПРИНЦИПЫ                                    ║
╚══════════════════════════════════════════════════════════════════════════╝

🔑 ПРИНЦИП "УЗКОГО ГОРЛЫШКА"
   Операция работает со скоростью САМОГО МЕДЛЕННОГО элемента
   (номинал / оборудование / работники)

🔄 НЕПРЕРЫВНОЕ ОБОРУДОВАНИЕ (requiresContinuousOperation: true)
   • Занято ВЕСЬ ЦИКЛ операции
   • ЛИМИТИРУЕТ производительность
   • Нельзя использовать в других операциях одновременно

👤 ПОСТОЯННОЕ ПРИСУТСТВИЕ (requiresContinuousPresence: true)
   • Работник занят ВЕСЬ ЦИКЛ
   • Стоимость = ставка × длительность_цикла
   
   Если false:
   • Работник занят только на настройку (timeSpent)
   • Стоимость = (ставка / piecesPerHour) × количество_деталей

📊 VARIANCE (Разброс)
   Применяется к:
   • Производительности операции / оборудования / ролей
   • Расходу материалов
   • Стоимости оборудования и ставкам работников
