# Исправление системы закупок материалов
**Дата:** 24 октября 2025

## Проблема

После запуска симуляции пользователь наблюдал следующее:
- В первый день делается заявка на закупку материалов
- В последующие дни ничего не происходит
- Материалы не поступают на склад

## Причина

Проблема была в логике проверки входящих заказов материалов в файле `lib/simulation-v2/ResourceManager.ts`, строка 86.

### Старый код:
```typescript
const hasIncoming = this.plannedBatches.some(b => b.materialId === m.id && b.etaArrivalDay >= currentDay);
```

### Проблема с логикой

Условие использовало оператор `>=` вместо `>`, что приводило к блокировке новых заказов даже когда материал должен был прибыть **сегодня**.

#### Пример ошибочного поведения:

**День 1:**
- Запас материала "Газетная бумага": 0
- Порог заказа: 30 (50% от minStock=60)
- Условие `stock <= threshold` выполняется: `0 <= 30` ✓
- Условие `!hasIncoming` выполняется: `plannedBatches` пуст ✓
- **Заказ делается**: 300 шт, `etaArrivalDay = 2` (deliveryDays = 1)

**День 2 (до исправления):**
- Вызывается `dailyMaterialReplenishment(2)`
- Проверка: `hasIncoming = plannedBatches.some(b => b.etaArrivalDay >= 2)`
- `etaArrivalDay (2) >= currentDay (2)` = **true** ❌
- **Новый заказ НЕ делается**, хотя запас всё еще 0
- Затем вызывается `processIncomingMaterials(2)`
- Материал прибывает и добавляется к запасу

**Проблема:** Между заказом в день 1 и прибытием в день 2 проходит целый день, когда материала нет на складе, но новый заказ не делается из-за неправильного условия.

## Решение

Изменено условие проверки входящих заказов:

### Новый код:
```typescript
const hasIncoming = this.plannedBatches.some(b => b.materialId === m.id && b.etaArrivalDay > currentDay);
```

Использование оператора `>` вместо `>=` позволяет делать новый заказ в тот же день, когда предыдущий заказ должен прибыть.

### Правильное поведение (после исправления):

**День 2 (после исправления):**
- Вызывается `dailyMaterialReplenishment(2)`
- Проверка: `hasIncoming = plannedBatches.some(b => b.etaArrivalDay > 2)`
- `etaArrivalDay (2) > currentDay (2)` = **false** ✓
- Условие `!hasIncoming` выполняется ✓
- Если `stock <= threshold`, можно сделать новый заказ
- Затем вызывается `processIncomingMaterials(2)`
- Первый заказ прибывает и удаляется из `plannedBatches`

## Технические детали

### Порядок вызовов в SimulationEngine

```typescript
// Утро каждого дня:
this.resources.dailyMaterialReplenishment(currentDay, settings);  // 1. Проверка и заказ
this.resources.processMaterialPostpay(currentDay);                 // 2. Постоплата
this.resources.processIncomingMaterials(currentDay);               // 3. Прибытие
```

### Логика заказа материалов

Материал заказывается, если выполняются ОБА условия:
1. `stock <= threshold` - запас упал ниже порога
2. `!hasIncoming` - нет входящих заказов в будущем

Где:
- `threshold = thresholdRatio * minStock`
- `thresholdRatio` = 0.5 (по умолчанию)
- `minStock` = 20% от количества заказа (если не указано явно)

### Время доставки

Для каждого материала задается:
- `manufacturingDays` - дней на производство
- `deliveryDays` - дней на доставку
- `etaArrivalDay = currentDay + manufacturingDays + deliveryDays`

**Примеры:**
- Вода холодная: 0 + 0 = 0 дней (прибывает в день заказа)
- Газетная бумага: 0 + 1 = 1 день
- Металл гарт: 0 + 3 = 3 дня

## Результат

После исправления симуляция работает корректно:
- Материалы заказываются автоматически при снижении запаса
- Материалы прибывают согласно заданному времени доставки
- Новые заказы делаются своевременно, не дожидаясь полного израсходования предыдущего заказа
- Производство может работать непрерывно при наличии достаточного запаса материалов

## Проверка

Для проверки работы системы закупок:
1. Откройте заказ в интерфейсе
2. Убедитесь, что для всех используемых материалов настроены партии закупок:
   - Количество заказа (quantity)
   - Цена за единицу (pricePerUnit)
   - Время производства (manufacturingDays)
   - Время доставки (deliveryDays)
   - Минимальный запас (minStock) - опционально, по умолчанию 20% от quantity
3. Запустите симуляцию
4. В разделе "Расходы и движение денежных средств" проверьте закупки материалов по дням
5. Убедитесь, что материалы заказываются и прибывают согласно графику

## Файлы, затронутые изменением

- `app/lib/simulation-v2/ResourceManager.ts` - исправлена строка 86
