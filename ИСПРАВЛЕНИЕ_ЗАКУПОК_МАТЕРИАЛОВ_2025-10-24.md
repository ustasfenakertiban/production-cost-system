# Исправление логики закупок материалов

## Дата: 24 октября 2025

## Проблема

Пользователь сообщил, что **отрицательные значения баланса должны быть допустимы** и **не должны влиять на возможность закупки материалов**. 

При проверке было обнаружено, что реальная проблема была в другом:
- В API-маршруте симуляции (`app/api/simulation-v2/run/route.ts`) функция `loadMaterials()` вызывалась **без параметра `orderId`**
- В результате для всех материалов устанавливалось значение `minOrderQty: 0`
- Материалы с `minOrderQty: 0` не закупаются в симуляции
- Это приводило к отсутствию расходов и остановке производства

## Что было исправлено

### 1. Передача orderId в loadMaterials

**Файл:** `app/api/simulation-v2/run/route.ts`

**Было:**
```typescript
const [materials, equipment, allEmployees, processSpec, settings, periodicExpenses] = await Promise.all([
  loadMaterials(),  // ❌ orderId не передается
  ...
]);
```

**Стало:**
```typescript
const [materials, equipment, allEmployees, processSpec, settings, periodicExpenses] = await Promise.all([
  loadMaterials(orderId),  // ✅ orderId передается
  ...
]);
```

### 2. Улучшена логика loadMaterials

**Файл:** `lib/simulation-v2/dataLoader.ts`

**Изменения:**

1. **Обязательность orderId:**
   - Теперь `orderId` является обязательным параметром
   - Если не указан - выбрасывается четкая ошибка

2. **Проверка наличия партий:**
   - Если для заказа нет партий закупок - выбрасывается ошибка с инструкциями
   - Пользователю предлагается настроить партии или импортировать их из шаблона

3. **Улучшены сообщения об ошибках:**
   - Понятные инструкции, что делать при отсутствии партий
   - Четкое указание на необходимость настройки партий для каждого заказа

## Логика работы с балансом

**Важно:** В коде симуляции **НЕТ проверки баланса перед закупками**.

Система работает следующим образом:
- Баланс может быть **любым**, включая отрицательный
- Закупки происходят **независимо от баланса**
- Баланс просто уменьшается при закупках: `cashBalance -= (cost + vat)`
- Отрицательный баланс означает кредит/овердрафт

**Примечание:** Предыдущее решение с увеличением `initialCashBalance` до 10 миллионов было **неверным**. Проблема была не в балансе, а в отсутствии передачи `orderId` в `loadMaterials()`.

## Как правильно использовать систему

### 1. Создание заказа

При создании заказа необходимо:
- Настроить партии закупок материалов
- Или импортировать их из сохраненного шаблона

### 2. Настройка партий закупок

Для каждого материала, используемого в производстве, нужно указать:
- **Количество** (`quantity`) - размер партии закупки
- **Цена за единицу** (`pricePerUnit`)
- **НДС** (`vatPercent`)
- **Минимальный остаток** (`minStock`)
- **Дни производства** (`manufacturingDays`)
- **Дни доставки** (`deliveryDays`)

### 3. Запуск симуляции

При запуске симуляции:
- Система загружает партии закупок для конкретного заказа
- Материалы автоматически закупаются при падении запаса ниже порога
- Баланс может уходить в минус - это нормально (кредит/овердрафт)

## Сообщения об ошибках

### "Для запуска симуляции необходимо указать ID заказа"

**Причина:** В API не передан `orderId`

**Решение:** Убедитесь, что запрос на симуляцию содержит `orderId` в теле запроса

### "Не настроены партии закупок материалов для этого заказа"

**Причина:** Для заказа не созданы партии закупок

**Решение:**
1. Откройте карточку заказа
2. Настройте партии закупок материалов вручную
3. Или импортируйте их из сохраненного шаблона (если есть)

## Технические детали

### Автоматические закупки

Система автоматически заказывает материалы каждый день по следующей логике:

```typescript
// Проверка необходимости закупки
if (stock <= threshold && !hasIncoming) {
  // Заказываем материал
  const qty = material.minOrderQty;  // ✅ Теперь берется из партии заказа
  // Рассчитываем стоимость
  const cost = material.unitCost * qty;
  const vat = cost * (material.vatRate / 100);
  // Списываем деньги (баланс может стать отрицательным!)
  cashBalance -= (cost + vat);
}
```

### Двухфазная оплата

Система поддерживает двухфазную оплату материалов:
- **Предоплата** - списывается в день заказа
- **Постоплата** - списывается в день готовности производства

Настройка в `GlobalSimulationSettingsV2`:
- `materialTwoPhasePayment` - включить/выключить
- `materialPrepayPercent` - процент предоплаты (0-1)

## Выводы

1. **Баланс НЕ влияет на закупки** - материалы покупаются независимо от баланса
2. **Отрицательный баланс допустим** - это кредит/овердрафт
3. **orderId обязателен** - для загрузки партий закупок конкретного заказа
4. **Партии обязательны** - без них материалы не будут закупаться
5. **Понятные ошибки** - система подсказывает, что делать при проблемах

---

**Статус:** ✅ Исправлено и протестировано
