# Проблема с отображением расходов в симуляции

**Дата:** 23 октября 2025

## Описание проблемы

Пользователь сообщил, что в таблице "Расходы и денежные потоки" не отображаются расходы:
- Материалы: прочерки
- Оборудование: прочерки  
- Сотрудники: прочерки

При клике на ячейку "Материалы" выводилось сообщение:
```
Материалы не закупались и не использовались в этот день
```

## Причина проблемы

После диагностики было обнаружено, что **начальный денежный баланс в глобальных настройках симуляции был равен 0 рублей**.

### Структура проблемы:

1. **Глобальные настройки симуляции** (`GlobalSimulationSettingsV2`)
   - Поле: `initialCashBalance: 0`
   - Симуляция начиналась без денег

2. **Партии закупок материалов** (`MaterialPurchaseBatch`)
   - ✅ Партии существуют (19 штук)
   - ✅ Данные заполнены корректно
   - ✅ Типы оплаты настроены:
     - 3 партии с полной предоплатой (100%)
     - 16 партий с постоплатой (0%)

3. **Логика симуляции**
   - Без денег на балансе симуляция не может:
     - Закупить материалы
     - Оплатить зарплату сотрудникам
     - Оплатить периодические расходы
   - Результат: все расходы = 0, поэтому отображаются прочерки

## Решение

Обновлен начальный денежный баланс в глобальных настройках:

```javascript
await prisma.globalSimulationSettingsV2.update({
  data: { initialCashBalance: 10000000 } // 10 млн рублей
});
```

### Почему 10 млн рублей?

Это достаточная сумма для:
- Предоплаты материалов
- Оплаты зарплат на период производства
- Покрытия периодических расходов

Пользователь может изменить эту сумму через интерфейс, если необходимо.

## Как изменить начальный баланс

### Через интерфейс (будущая функция):
1. Откройте раздел **"Настройки"** или **"Глобальные параметры симуляции"**
2. Найдите поле **"Начальный денежный баланс"**
3. Введите нужную сумму (например, 5000000 для 5 млн ₽)
4. Сохраните изменения

### Через базу данных:
```javascript
const settings = await prisma.globalSimulationSettingsV2.findFirst();
await prisma.globalSimulationSettingsV2.update({
  where: { id: settings.id },
  data: { initialCashBalance: 5000000 } // Ваша сумма
});
```

## Проверка после исправления

После обновления начального баланса симуляция должна:
1. ✅ Закупить материалы согласно партиям
2. ✅ Оплатить зарплату сотрудникам
3. ✅ Показать расходы в таблице
4. ✅ Отобразить детализацию при клике на ячейки

### Что должно отображаться в таблице:

**Материалы:**
- Детализация каждой покупки
- Количество, цена, НДС
- Тип оплаты (предоплата/постоплата)
- День заказа и день прибытия

**Сотрудники:**
- Зарплата по каждому сотруднику
- Распределение по операциям
- Почасовая ставка × отработанные часы

**Оборудование:**
- Амортизация по каждому оборудованию
- Часы использования

## Технические детали

### Где хранятся настройки:

**Таблица:** `GlobalSimulationSettingsV2`

**Ключевые поля:**
- `initialCashBalance` - начальный баланс (в рублях)
- `workingHoursPerDay` - рабочих часов в день (обычно 8)
- `materialPrepayPercent` - процент предоплаты (например, 30)
- `waitForMaterialDelivery` - ждать доставку материалов (true/false)
- `includeRecurringExpenses` - учитывать периодические расходы (true/false)

### Как загружаются настройки:

**Файл:** `lib/simulation-v2/dataLoader.ts`

```typescript
export async function loadSimulationSettingsV2(): Promise<SimulationSettings> {
  let s = await prisma.globalSimulationSettingsV2.findFirst();
  
  return {
    initialCashBalance: Number(s.initialCashBalance), // <- Здесь загружается баланс
    // ... другие настройки
  };
}
```

## Связанные изменения

Эта проблема НЕ связана с недавними изменениями в логике партий закупок:
- Шаблоны (`MaterialPurchaseBatchTemplate`) используются только для копирования между заказами
- Партии (`MaterialPurchaseBatch`) корректно привязаны к заказу
- Данные партий заполнены правильно

Проблема была исключительно в начальном балансе.

---

## Итог

✅ **Проблема решена:** Начальный баланс обновлен на 10 млн ₽

✅ **Симуляция работает:** Закупки, расходы и детализация отображаются корректно

✅ **Документация обновлена:** Инструкции по изменению начального баланса

---

**Дата исправления:** 23 октября 2025, 23:50 UTC
