
# Финансовые итоги - Документация

## Обзор

Добавлена новая вкладка **"Финансовые итоги"** в результаты симуляции, которая предоставляет детальный анализ финансовых показателей выполнения заказа.

## Внесенные изменения

### 1. Новый компонент `FinancialSummary`

**Файл:** `/app/components/financial-summary.tsx`

Компонент отображает полный финансовый анализ заказа с учетом всех расходов, налогов и прибыли.

#### Основные функции:

1. **Сумма заказа** - вычисляется из продажной цены с НДС × количество товаров
2. **Остаток средств после производства** - баланс после всех производственных расходов
3. **Учет периодических расходов** (опционально):
   - Чекбокс для включения/выключения учета
   - Автоматическое приведение периодических расходов к дневной ставке:
     - День: делится на 1
     - Неделя: делится на 7
     - Месяц: делится на 30
     - Квартал: делится на 90
     - Год: делится на 365
   - Умножение на количество дней производства
   - Детальное отображение каждого расхода
4. **Расчет НДС** - от общей суммы заказа (по ставке из настроек)
5. **Прибыль - НДС** - остаток средств минус НДС
6. **Налог на прибыль** - по ставке из настроек симуляции v2
7. **Чистая прибыль** - после вычета всех налогов
8. **Маржа в %** - чистая прибыль от общей суммы заказа с визуальным индикатором

#### Источники данных:

- **Настройки симуляции v2**: продажная цена, ставка НДС, налог на прибыль
- **Периодические расходы**: активные расходы из базы данных
- **Результаты симуляции**: баланс, количество дней, суммы расходов

### 2. Обновление `simulation-panel.tsx`

**Файл:** `/app/app/orders/[id]/simulation-panel.tsx`

#### Изменения:

1. Добавлен импорт компонента `FinancialSummary`
2. Добавлено состояние `orderQuantity` для хранения количества заказа
3. Обновлен `TabsList` - увеличено количество колонок до 10
4. Добавлена новая вкладка `"financial"` - "Финансовые итоги"
5. В функции `runSimulationV2WithEmployees`:
   - Сохранение количества заказа в состояние
   - Передача количества в компонент `FinancialSummary`
6. Обновлен текстовый лог:
   - Добавлен раздел "ОСТАТОК СРЕДСТВ ПОСЛЕ ПРОИЗВОДСТВА"
   - Отображается в конце итоговой сводки

### 3. Расположение вкладок

Теперь вкладки расположены в следующем порядке:
1. **Итоги** - общая сводка
2. **Финансовые итоги** ⭐ НОВАЯ
3. Структура затрат
4. Затраты по операциям
5. Зарплаты по операциям
6. Денежные потоки
7. Древовидный вид
8. Таблица v1
9. Таблица v2
10. Текстовый лог

## Формулы расчета

### Сумма заказа
```
orderTotal = sellingPriceWithVAT × orderQuantity
```

### Остаток после периодических расходов
```
dailyPeriodicExpenses = Σ (expense.amount / divisor)
totalPeriodicExpensesForOrder = dailyPeriodicExpenses × totalDays
remainingAfterPeriodic = cashEnding - totalPeriodicExpensesForOrder
```

где `divisor` зависит от периода:
- День: 1
- Неделя: 7
- Месяц: 30
- Квартал: 90
- Год: 365

### НДС
```
vatAmount = orderTotal × (vatRate / 100) / (1 + vatRate / 100)
```

### Прибыль до налогообложения
```
profitBeforeTax = remainingAfterPeriodic - vatAmount
```

### Налог на прибыль
```
profitTaxAmount = profitBeforeTax × (profitTaxRate / 100)
```
(только если profitBeforeTax > 0)

### Чистая прибыль
```
netProfit = profitBeforeTax - profitTaxAmount
```

### Маржа
```
marginPercent = (netProfit / orderTotal) × 100
```

## Визуальные элементы

### Цветовая индикация

- **Положительные значения**: зеленый цвет
- **Отрицательные значения**: красный цвет
- **Налоги и расходы**: оранжевый цвет
- **Основная информация**: синий цвет

### Индикатор маржи

Прогресс-бар с цветовой градацией:
- **≥ 20%**: зеленый (отличная маржа)
- **≥ 10%**: желтый (хорошая маржа)
- **≥ 0%**: оранжевый (низкая маржа)
- **< 0%**: красный (убыток)

## Использование

1. Запустите симуляцию v2 из страницы заказа
2. После завершения симуляции перейдите на вкладку **"Финансовые итоги"**
3. Проверьте все финансовые показатели
4. При необходимости включите чекбокс "Учитывать периодические расходы"
5. Для изменения ставок НДС и налога на прибыль перейдите в "Настройки симуляции v2"

## Требования

- Продажная цена с НДС должна быть указана в настройках симуляции v2
- Для учета периодических расходов должны быть настроены активные периодические расходы
- Симуляция должна быть завершена успешно

## Примечания

- Все расчеты основаны на данных симуляции и настройках в форме "Настройки симуляции v2"
- Остаток средств также записывается в текстовый лог в разделе "ИТОГОВАЯ СВОДКА"
- Компонент автоматически загружает необходимые данные из API
- При отсутствии продажной цены выводится предупреждение

---

**Дата создания:** 23 октября 2025  
**Версия:** 1.0
