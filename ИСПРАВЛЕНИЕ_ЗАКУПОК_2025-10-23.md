# Исправление логики закупок материалов
## 23 октября 2025 г.

## Проблема

В системе симуляции была обнаружена критическая ошибка в логике закупок материалов:

### 1. **Использование дефолтных значений**
   - Если для заказа не были настроены партии закупок материалов, система автоматически использовала значения по умолчанию:
     - **minOrderQty = 100** (закупка 100 единиц каждого материала)
     - **minStock = 20** (минимальный остаток на складе)
   - Это приводило к покупке огромных количеств материалов на миллионы рублей без необходимости

### 2. **Игнорирование шаблонов закупок**
   - В системе существует механизм **шаблонов закупок материалов** (MaterialPurchaseBatchTemplate)
   - Эти шаблоны должны применяться к каждому заказу для создания **партий закупок** (MaterialPurchaseBatch)
   - Однако система не проверяла наличие шаблонов и не требовала их заполнения

### 3. **Пример проблемы**
В базе данных:
- **20 материалов** настроено
- **0 шаблонов закупок** создано
- **0 партий закупок** для заказов

Результат симуляции:
- Каждый материал закупается по **100 единиц**
- Общая стоимость закупок: **миллионы рублей**
- НДС неправильно рассчитан (20000% вместо 20%)

---

## Решение

### Изменения в файле `lib/simulation-v2/dataLoader.ts`

#### **1. Проверка наличия партий закупок для заказа**
```typescript
// Если для заказа нет партий - это ошибка
if (batches.length === 0) {
  throw new Error(
    'Не настроены партии закупок материалов для этого заказа. ' +
    'Откройте карточку заказа и настройте партии закупок материалов вручную, ' +
    'либо импортируйте их из шаблона (если есть сохраненный шаблон из другого заказа).'
  );
}
```

**Логика:**
- Если для заказа нет партий закупок (MaterialPurchaseBatch) → **ошибка**
- Шаблоны (MaterialPurchaseBatchTemplate) НЕ проверяются - они используются только для копирования настроек между заказами
- Партии должны быть настроены вручную ИЛИ импортированы из шаблона

#### **2. Отключение дефолтных значений**
```typescript
// Если партии нет для заказа - возвращаем нулевые значения
return {
  id: String(r.id),
  name: r.name,
  unitCost: Number(r.cost ?? 0),
  vatRate: Number(r.vatPercentage ?? 0),
  minStock: 0,
  minOrderQty: 0, // Нулевой размер заказа = материал не будет закупаться
  leadTimeProductionDays: 0,
  leadTimeShippingDays: 0,
};
```

**Результат:**
- Материалы без партий **НЕ будут закупаться** (minOrderQty = 0)
- Система **НЕ будет** использовать дефолтные значения
- Пользователь **обязан** настроить данные перед симуляцией

---

## Как правильно использовать систему

### Вариант 1: Настроить партии закупок вручную
1. Откройте карточку заказа
2. Найдите раздел **"Партии закупок материалов"**
3. Для каждого необходимого материала добавьте партию закупки:
   - Количество в партии
   - Цена за единицу
   - НДС (%)
   - Тип оплаты (полная/предоплата/постоплата)
   - Процент предоплаты (если применимо)
   - Дни производства
   - Дни доставки
   - Минимальный остаток на складе

### Вариант 2: Использовать шаблон (если есть сохраненный)
1. Если вы уже настраивали партии для другого заказа, можете сохранить их как шаблон
2. Откройте новую карточку заказа
3. Найдите раздел с партиями закупок материалов
4. Нажмите кнопку **"Импортировать из шаблона"**
5. Выберите нужный шаблон
6. Система создаст партии закупок для всех материалов из шаблона

### Важно понимать про шаблоны
- **Шаблоны** - это просто способ скопировать настройки закупок из одного заказа в другой
- Они **НЕ используются** напрямую в расчетах симуляции
- Расчеты используют только **партии закупок** (MaterialPurchaseBatch), привязанные к конкретному заказу

### После настройки партий
- Запустите симуляцию
- Система будет использовать **реальные данные** из партий закупок
- Никаких дефолтных значений не будет использоваться

---

## Преимущества нового подхода

### ✅ **Точность расчетов**
- Система использует только реальные данные
- Нет случайных закупок на миллионы рублей

### ✅ **Явная валидация**
- Если данные не заполнены → понятная ошибка
- Пользователь знает, что нужно сделать

### ✅ **Гибкость**
- Можно создать несколько шаблонов для разных сценариев
- Можно настроить партии вручную для конкретного заказа

### ✅ **Безопасность**
- Нет автоматических закупок без явного согласия
- Полный контроль над расходами

---

## Технические детали

### Структура данных

1. **MaterialPurchaseBatch** (Партии для заказа) - **ИСПОЛЬЗУЕТСЯ В РАСЧЕТАХ**
   - Хранятся в таблице `material_purchase_batches`
   - Привязаны к конкретному заказу (`orderId`)
   - **Это единственный источник данных для симуляции**
   - Создаются вручную или импортируются из шаблонов

2. **MaterialPurchaseBatchTemplate** (Шаблоны) - **ТОЛЬКО ДЛЯ КОПИРОВАНИЯ**
   - Хранятся в таблице `material_purchase_batch_templates`
   - Одна запись на каждый материал в шаблоне
   - **НЕ используются напрямую в расчетах**
   - Используются только для переноса настроек между заказами

3. **Workflow использования шаблонов (опционально)**
   ```
   Заказ 1 → Настроить партии вручную → Сохранить как шаблон
   Заказ 2 → Импортировать из шаблона → Получить партии
   ```
   
   Или без шаблонов:
   ```
   Заказ → Настроить партии вручную → Готово
   ```

### API endpoints

- `POST /api/material-purchase-batch-templates` - создать шаблон
- `GET /api/material-purchase-batch-templates` - список шаблонов
- `POST /api/orders/[id]/material-batches/apply-template` - применить шаблон к заказу
- `GET /api/material-purchase-batches?orderId=...` - партии для заказа

---

## Примеры ошибок

### Ошибка: Нет партий закупок для заказа
```
Error: Не настроены партии закупок материалов для этого заказа.
Откройте карточку заказа и настройте партии закупок материалов вручную,
либо импортируйте их из шаблона (если есть сохраненный шаблон из другого заказа).
```

**Решение:** 
1. Откройте карточку заказа
2. Настройте партии закупок вручную для необходимых материалов
3. ИЛИ импортируйте партии из ранее сохраненного шаблона (если есть)

---

## Заключение

Исправление устраняет критическую ошибку в логике закупок материалов:
- ❌ **Было:** Автоматическая покупка 100 единиц каждого материала
- ✅ **Стало:** Обязательная настройка партий закупок перед симуляцией

Это делает систему более **предсказуемой**, **точной** и **безопасной** в использовании.
