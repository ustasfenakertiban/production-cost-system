# Исправление логики закупок материалов
## 23 октября 2025 г.

## Проблема

В системе симуляции была обнаружена критическая ошибка в логике закупок материалов:

### 1. **Использование дефолтных значений**
   - Если для заказа не были настроены партии закупок материалов, система автоматически использовала значения по умолчанию:
     - **minOrderQty = 100** (закупка 100 единиц каждого материала)
     - **minStock = 20** (минимальный остаток на складе)
   - Это приводило к покупке огромных количеств материалов на миллионы рублей без необходимости

### 2. **Игнорирование шаблонов закупок**
   - В системе существует механизм **шаблонов закупок материалов** (MaterialPurchaseBatchTemplate)
   - Эти шаблоны должны применяться к каждому заказу для создания **партий закупок** (MaterialPurchaseBatch)
   - Однако система не проверяла наличие шаблонов и не требовала их заполнения

### 3. **Пример проблемы**
В базе данных:
- **20 материалов** настроено
- **0 шаблонов закупок** создано
- **0 партий закупок** для заказов

Результат симуляции:
- Каждый материал закупается по **100 единиц**
- Общая стоимость закупок: **миллионы рублей**
- НДС неправильно рассчитан (20000% вместо 20%)

---

## Решение

### Изменения в файле `lib/simulation-v2/dataLoader.ts`

#### **1. Проверка наличия данных для заказа**
```typescript
// Если указан orderId, но нет партий - проверяем шаблоны
if (orderId && batches.length === 0) {
  const templates = await prisma.materialPurchaseBatchTemplate.findMany();
  if (templates.length === 0) {
    throw new Error(
      'Не настроены партии закупок материалов для этого заказа. ' +
      'Пожалуйста, создайте шаблоны закупок материалов (Purchases → Templates) ' +
      'и примените их к заказу, либо настройте партии вручную в карточке заказа.'
    );
  } else {
    throw new Error(
      `Найдено ${templates.length} шаблон(ов) закупок, но они не применены к заказу. ` +
      'Откройте карточку заказа и примените шаблон закупок материалов.'
    );
  }
}
```

**Логика:**
- Если для заказа нет партий закупок → проверяем шаблоны
- Если шаблонов нет → **ошибка с инструкцией создать шаблоны**
- Если шаблоны есть → **ошибка с инструкцией применить их**

#### **2. Отключение дефолтных значений**
```typescript
// Если партии нет для заказа - возвращаем нулевые значения
return {
  id: String(r.id),
  name: r.name,
  unitCost: Number(r.cost ?? 0),
  vatRate: Number(r.vatPercentage ?? 0),
  minStock: 0,
  minOrderQty: 0, // Нулевой размер заказа = материал не будет закупаться
  leadTimeProductionDays: 0,
  leadTimeShippingDays: 0,
};
```

**Результат:**
- Материалы без партий **НЕ будут закупаться** (minOrderQty = 0)
- Система **НЕ будет** использовать дефолтные значения
- Пользователь **обязан** настроить данные перед симуляцией

---

## Как правильно использовать систему

### Шаг 1: Создать шаблоны закупок материалов
1. Откройте раздел **Purchases → Templates** (или `/material-purchase-batch-templates`)
2. Для каждого материала создайте шаблон закупки:
   - Количество в партии
   - Цена за единицу
   - НДС (%)
   - Тип оплаты (полная/предоплата/постоплата)
   - Процент предоплаты (если применимо)
   - Дни производства
   - Дни доставки
   - Минимальный остаток на складе

### Шаг 2: Применить шаблоны к заказу
1. Откройте карточку заказа
2. Найдите раздел с партиями закупок материалов
3. Нажмите кнопку **"Применить шаблон"**
4. Выберите нужный шаблон
5. Система создаст партии закупок для всех материалов из шаблона

### Шаг 3: Запустить симуляцию
- Теперь симуляция будет использовать **реальные данные** из партий закупок
- Никаких дефолтных значений не будет использоваться

---

## Преимущества нового подхода

### ✅ **Точность расчетов**
- Система использует только реальные данные
- Нет случайных закупок на миллионы рублей

### ✅ **Явная валидация**
- Если данные не заполнены → понятная ошибка
- Пользователь знает, что нужно сделать

### ✅ **Гибкость**
- Можно создать несколько шаблонов для разных сценариев
- Можно настроить партии вручную для конкретного заказа

### ✅ **Безопасность**
- Нет автоматических закупок без явного согласия
- Полный контроль над расходами

---

## Технические детали

### Структура данных

1. **MaterialPurchaseBatchTemplate** (Глобальные шаблоны)
   - Хранятся в таблице `material_purchase_batch_templates`
   - Одна запись на каждый материал в шаблоне
   - Можно создавать несколько шаблонов с разными параметрами

2. **MaterialPurchaseBatch** (Партии для заказа)
   - Хранятся в таблице `material_purchase_batches`
   - Привязаны к конкретному заказу (`orderId`)
   - Создаются из шаблонов или вручную

3. **Связь между шаблонами и партиями**
   ```
   Template → Apply to Order → Batch
   ```

### API endpoints

- `POST /api/material-purchase-batch-templates` - создать шаблон
- `GET /api/material-purchase-batch-templates` - список шаблонов
- `POST /api/orders/[id]/material-batches/apply-template` - применить шаблон к заказу
- `GET /api/material-purchase-batches?orderId=...` - партии для заказа

---

## Примеры ошибок

### Ошибка 1: Нет шаблонов
```
Error: Не настроены партии закупок материалов для этого заказа.
Пожалуйста, создайте шаблоны закупок материалов (Purchases → Templates)
и примените их к заказу, либо настройте партии вручную в карточке заказа.
```

**Решение:** Создайте шаблоны закупок

### Ошибка 2: Шаблоны есть, но не применены
```
Error: Найдено 5 шаблон(ов) закупок, но они не применены к заказу.
Откройте карточку заказа и примените шаблон закупок материалов.
```

**Решение:** Примените шаблон к заказу

---

## Заключение

Исправление устраняет критическую ошибку в логике закупок материалов:
- ❌ **Было:** Автоматическая покупка 100 единиц каждого материала
- ✅ **Стало:** Обязательная настройка партий закупок перед симуляцией

Это делает систему более **предсказуемой**, **точной** и **безопасной** в использовании.
